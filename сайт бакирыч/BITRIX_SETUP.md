# Инструкция по настройке интеграции с Bitrix

## Шаг 1: Размещение файлов

1. Скопируйте файл `local/ajax/form_handler.php` в корень вашего Bitrix сайта:
   ```
   /local/ajax/form_handler.php
   ```

2. Убедитесь, что структура директорий существует:
   ```
   /local/ajax/
   ```

## Шаг 2: Настройка пользовательских полей в CRM

Для корректной работы необходимо создать пользовательские поля в Bitrix CRM для сущности "Лиды":

### Создание полей через интерфейс:

1. Перейдите в **CRM → Настройки → Настройка полей → Лиды**
2. Создайте следующие поля:

#### Поле "Сумма кредита"
- **Тип**: Число
- **Код**: `UF_CRM_CREDIT_AMOUNT`
- **Название**: Сумма кредита
- **Обязательное**: Нет

#### Поле "Название банка"
- **Тип**: Строка
- **Код**: `UF_CRM_BANK_NAME`
- **Название**: Название банка
- **Обязательное**: Нет

#### Поле "Дата покупки"
- **Тип**: Список
- **Код**: `UF_CRM_PURCHASE_DATE`
- **Название**: Когда купили автомобиль
- **Варианты**:
  - Меньше 30 дней
  - Больше 30 дней

#### Поле "Навязанные услуги"
- **Тип**: Строка (многострочное)
- **Код**: `UF_CRM_IMPOSED_SERVICES`
- **Название**: Навязанные услуги
- **Обязательное**: Нет

### Альтернативный способ (через код):

Если у вас есть доступ к коду, можно создать поля программно через API Bitrix.

## Шаг 3: Проверка прав доступа

Убедитесь, что пользователь, от имени которого выполняется скрипт, имеет права:
- Создание лидов в CRM
- Доступ к модулю CRM

## Шаг 4: Настройка URL в JavaScript

В файле `js/script.js` проверьте URL для отправки данных:

```javascript
const bitrixWebhookUrl = '/local/ajax/form_handler.php';
```

Если файл находится в другом месте, обновите путь.

## Шаг 5: Тестирование

1. Заполните форму на сайте
2. Отправьте заявку
3. Проверьте в Bitrix CRM → Лиды, что лид создан
4. Проверьте, что все поля заполнены корректно

## Шаг 6: Настройка автоматизации (опционально)

После создания лида можно настроить автоматизацию:

1. **Автоматическое назначение ответственного** - назначить менеджера по автокредитам
2. **Отправка уведомлений** - уведомить менеджера о новой заявке
3. **Создание задачи** - создать задачу на обработку заявки
4. **Отправка email** - отправить подтверждение клиенту

Настройка выполняется в **CRM → Автоматизация → Бизнес-процессы**

## Решение проблем

### Ошибка "Access denied"
- Проверьте права доступа пользователя
- Убедитесь, что модуль CRM установлен и активен

### Поля не сохраняются
- Проверьте, что коды полей совпадают с указанными в `form_handler.php`
- Убедитесь, что поля созданы для сущности "Лиды"

### Лиды не создаются
- Проверьте логи ошибок Bitrix
- Убедитесь, что файл `form_handler.php` размещен в правильной директории
- Проверьте права на запись в базу данных

## Дополнительные настройки

### Настройка источника лида

В файле `form_handler.php` можно изменить источник лида:

```php
'SOURCE_ID' => 'WEB', // или ID вашего источника
```

Создайте источник "Лендинг автокредит" в **CRM → Настройки → Справочники → Источники** и используйте его ID.

### Настройка статуса лида

Можно автоматически устанавливать статус:

```php
'STATUS_ID' => 'NEW', // или другой статус
```

### Добавление тегов

Можно автоматически добавлять теги к лидам:

```php
// После создания лида
$lead->Update($leadId, ['UF_CRM_TAGS' => 'автокредит, возврат']);
```

